---
import type { CollectionEntry } from 'astro:content';
import Base from './Base.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';

type Props = CollectionEntry<'blog'>['data'] & {
    headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;

// Extract slug from URL for display
const slug = Astro.url.pathname.replace(/\/$/, '').split('/').pop() || 'index';
const isBlog = Astro.url.pathname.includes('/blog/');
const displayPath = isBlog ? `journal/${slug}.md` : `${slug}.md`;
const promptPath = isBlog ? '~/journal' : '~';
---

<Base
  title={title}
  description={description}
  path={displayPath}
  metadata={{ pubDate, tags: ['memory', 'log'], ...Astro.props }}
  headings={headings}
>
  <div class="terminal-command">
      <span class="prompt">funes@memoria:{promptPath}$</span> cat {slug}.md
  </div>

  <article class="blog-post">
    <div class="hero-image">
        {heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
    </div>

    <div class="prose">
        <div class="title">
            <div class="date">
                <FormattedDate date={pubDate} />
                {
                    updatedDate && (
                        <div class="last-updated-on">
                            Last updated on <FormattedDate date={updatedDate} />
                        </div>
                    )
                }
            </div>
            <h1>{title}</h1>
            <hr />
        </div>

        <slot />
    </div>
  </article>

  <!-- Marginalia Placeholder (Desktop Only) -->
  <aside class="marginalia-container">
      <!-- Logic to inject marginalia would go here -->
  </aside>
</Base>

<style>
  .terminal-command {
      color: var(--funes-text-main);
      margin-bottom: var(--space-lg);
      font-family: var(--font-mono);
  }

  .prompt {
      color: var(--funes-terminal);
      margin-right: var(--space-sm);
  }

  .blog-post {
      background: var(--funes-bg-dark);
      /* Subtle texture could go here */
  }

  .hero-image {
      width: 100%;
      margin-bottom: var(--space-lg);
  }

  .hero-image img {
      display: block;
      margin: 0 auto;
      border-radius: 4px;
      border: 1px solid var(--funes-text-dimmer);
  }

  .prose {
      max-width: var(--content-max-width);
      margin: 0 auto;
      color: var(--funes-text-main);
      font-family: var(--font-mono); /* Default to mono, specific elements override to serif */
  }

  .title {
      margin-bottom: var(--space-xl);
      text-align: left;
  }

  .date {
      margin-bottom: var(--space-sm);
      color: var(--funes-text-dim);
      font-family: var(--font-mono);
      font-size: var(--text-sm);
  }

  .last-updated-on {
      font-style: italic;
  }

  hr {
      border: none;
      border-top: 1px dashed var(--funes-text-dimmer);
      margin: var(--space-lg) 0;
  }
</style>
