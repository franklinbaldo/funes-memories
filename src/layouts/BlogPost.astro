---
import type { CollectionEntry } from 'astro:content';
import Base from './Base.astro';
import FileTree from '../components/FileTree.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';
import fs from 'node:fs/promises';

type Props = CollectionEntry<'blog'>['data'] & {
    headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;

// Extract slug from URL for display
const slug = Astro.url.pathname.replace(/\/$/, '').split('/').pop() || 'index';

function parseCsv(text: string) {
  const rows: string[][] = [];
  let row: string[] = [];
  let field = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const next = text[i + 1];

    if (char === '"') {
      if (inQuotes && next === '"') {
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (char === '\n' && !inQuotes) {
      row.push(field);
      rows.push(row);
      row = [];
      field = '';
      continue;
    }

    if (char === ',' && !inQuotes) {
      row.push(field);
      field = '';
      continue;
    }

    if (char === '\r') {
      continue;
    }

    field += char;
  }

  if (field.length || row.length) {
    row.push(field);
    rows.push(row);
  }

  return rows;
}

const commentsPath = new URL('../content/blog-comments.csv', import.meta.url);
let commentsForPost: Array<{ ts: string; persona: string; model: string; comment: string }> = [];
try {
  const csvText = await fs.readFile(commentsPath, 'utf-8');
  const rows = parseCsv(csvText.trim());
  const [header, ...data] = rows;
  const idx = (name: string) => header.indexOf(name);
  const bySlug = idx('post_slug');
  const byPersona = idx('persona');
  const byModel = idx('model');
  const byComment = idx('comment');
  const byTs = idx('ts');

  commentsForPost = data
    .filter((row) => row[bySlug] === slug)
    .map((row) => ({
      ts: row[byTs],
      persona: row[byPersona],
      model: row[byModel],
      comment: row[byComment],
    }));
} catch {
  commentsForPost = [];
}
---

<Base
  title={title}
  description={description}
  image={heroImage}
>
  <!-- Left Sidebar: Meta -->
  <div slot="left-sidebar" class="sticky top-32 flex flex-col gap-8">
    <div class="flex flex-col gap-2">
      <h3 class="text-signal font-mono text-xs tracking-widest uppercase">DATELINE</h3>
      <div class="text-ink-dim font-mono text-sm">
        <FormattedDate date={pubDate} />
        {updatedDate && (
          <div class="mt-1 text-[10px] italic">
            MODIFIED: <FormattedDate date={updatedDate} />
          </div>
        )}
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <h3 class="text-signal font-mono text-xs tracking-widest uppercase">ID</h3>
      <div class="text-ink-dim font-mono text-sm truncate">
        {slug}
      </div>
    </div>

    <div class="mt-8">
      <h3 class="text-signal font-mono text-xs tracking-widest uppercase mb-4">NAVIGATOR</h3>
      <FileTree />
    </div>

    <nav class="mt-8 flex flex-col gap-4">
      <h3 class="text-signal font-mono text-xs tracking-widest uppercase">INDEX</h3>
      <div class="flex flex-col gap-2">
        {headings.filter(h => h.depth <= 3).map(h => (
          <a href={`#${h.slug}`} class="text-ink-dim hover:text-candle text-xs font-mono transition-colors">
            {h.text}
          </a>
        ))}
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <article>
    <header class="mb-16">
      <h1 class="mb-8">{title}</h1>
      {description && <p class="text-xl md:text-2xl text-ink-dim italic font-serif leading-relaxed">{description}</p>}
      
      {heroImage && (
        <div class="mt-12 overflow-hidden rounded-sm border border-line">
          <Image width={1020} height={510} src={heroImage} alt="" class="w-full grayscale hover:grayscale-0 transition-all duration-700" />
        </div>
      )}
    </header>

    <div class="prose prose-invert prose-lg max-w-none">
      <slot />
    </div>

    {commentsForPost.length > 0 && (
      <section class="mt-32 pt-12 border-t border-line">
        <h3 class="text-signal font-mono text-sm tracking-widest uppercase mb-12">TRANSCRIPTS</h3>
        <div class="space-y-12">
          {commentsForPost.map((c) => (
            <div class="flex flex-col gap-4">
              <div class="flex items-center gap-4">
                <span class="text-candle font-mono text-xs">[{c.ts}]</span>
                <span class="text-ink font-mono text-sm uppercase">{c.persona}</span>
                <span class="text-ink-dim font-mono text-[10px]">{c.model}</span>
              </div>
              <div class="text-ink-dim font-serif text-lg leading-relaxed italic border-l border-candle/30 pl-6">
                {c.comment}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </article>

  <!-- Right Sidebar: Marginalia -->
  <div slot="right-sidebar" class="sticky top-32">
    <div id="marginalia-target" class="flex flex-col gap-12">
      <!-- Sidenotes will be injected or positioned here via CSS/JS -->
      <div class="p-4 bg-surface/50 border-l border-candle text-candle font-mono text-xs leading-relaxed">
        <span class="uppercase block mb-2 opacity-50">Note_01</span>
        THIS ARCHIVE IS APPEND-ONLY. ERRORS ARE PRESERVED AS HISTORICAL MARKERS.
      </div>
    </div>
  </div>
</Base>
