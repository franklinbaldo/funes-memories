---
interface Props {
  metadata?: Record<string, any>;
  headings?: { depth: number; slug: string; text: string }[];
  relatedPosts?: any[];
}

const { metadata = {}, headings = [], relatedPosts = [] } = Astro.props;
const baseUrlRaw = import.meta.env.BASE_URL || '/';
const baseUrl = baseUrlRaw.endsWith('/') ? baseUrlRaw : `${baseUrlRaw}/`;

const safeHeadings = Array.isArray(headings) ? headings : [];
const safeRelatedPosts = Array.isArray(relatedPosts) ? relatedPosts : [];
---

<aside class="flex flex-col gap-8 pt-6 font-mono text-xs text-ink-dim w-full">

  <!-- Metadata Card -->
  <div class="bg-surface border border-line shadow-sm">
    <div class="bg-white/5 border-b border-line px-4 py-2 font-bold text-ink tracking-widest uppercase flex items-center gap-2">
      <span class="text-signal">::</span> METADATA
    </div>
    <div class="p-4 space-y-3">
      {metadata.pubDate && (
        <div class="flex flex-col gap-1">
          <span class="text-ink-dim/60 text-[10px] uppercase tracking-wider">DATE_LOGGED</span>
          <span class="text-ink">{new Date(metadata.pubDate).toISOString().split('T')[0]}</span>
        </div>
      )}

      {metadata.tags && Array.isArray(metadata.tags) && (
        <div class="flex flex-col gap-1">
          <span class="text-ink-dim/60 text-[10px] uppercase tracking-wider">TAGS</span>
          <div class="flex flex-wrap gap-2">
            {metadata.tags.map((tag: string) => (
              <span class="text-link hover:text-candle cursor-pointer transition-colors">#{tag}</span>
            ))}
          </div>
        </div>
      )}

      <div class="flex flex-col gap-1">
          <span class="text-ink-dim/60 text-[10px] uppercase tracking-wider">TYPE</span>
          <span class="text-ink">MEMORY_LOG</span>
      </div>
    </div>
  </div>

  <!-- Table of Contents Card -->
  {safeHeadings.length > 0 && (
    <div class="bg-surface border border-line shadow-sm hidden lg:block">
      <div class="bg-white/5 border-b border-line px-4 py-2 font-bold text-ink tracking-widest uppercase flex items-center gap-2">
        <span class="text-signal">::</span> INDEX
      </div>
      <div class="p-4">
        <ul class="space-y-2">
          {safeHeadings.filter(h => h.depth <= 3).map((heading) => (
            <li class={`transition-colors hover:text-candle ${heading.depth === 3 ? 'pl-3 text-[10px] opacity-80' : ''}`}>
              <a href={`#${heading.slug}`} class="block py-0.5 truncate border-l-2 border-transparent hover:border-signal pl-2 -ml-2">
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  )}

  <!-- Related Posts Card -->
  {safeRelatedPosts.length > 0 && (
    <div class="bg-surface border border-line shadow-sm">
      <div class="bg-white/5 border-b border-line px-4 py-2 font-bold text-ink tracking-widest uppercase flex items-center gap-2">
        <span class="text-signal">::</span> RELATED_ENTRIES
      </div>
      <div class="p-4">
        <ul class="space-y-3">
            {safeRelatedPosts.map(post => (
                <li>
                    <a href={`${baseUrl}blog/${post.id}/`} class="block group">
                      <span class="text-link group-hover:text-candle transition-colors block mb-0.5 leading-tight">
                        {post.data.title}
                      </span>
                      <span class="text-[10px] text-ink-dim/50 group-hover:text-ink-dim transition-colors">
                        {new Date(post.data.pubDate).toISOString().split('T')[0]}
                      </span>
                    </a>
                </li>
            ))}
        </ul>
      </div>
    </div>
  )}
</aside>
